var EarthJsHelper;!function(a){var b=function(){function b(){a.Container.instance=this,this.dependencies={}}return b.prototype.register=function(a,b){this.dependencies[a]=b},b}();a.Container=b}(EarthJsHelper||(EarthJsHelper={}));var EarthJsModel;!function(a){var b=function(){function a(a,b,c,d){this.x=a,this.y=b,this.z=c,this.earthRadius=null!=d&&void 0!=d?d:Math.sqrt(Math.pow(a,2)+Math.pow(b,2)+Math.pow(c,2))}return a.prototype.calculateLatitudeLongitude=function(){var a=this.x,b=this.y,d=-this.z,e=6378137/this.earthRadius;a*=e,d*=e,b*=e;var f,g,h,i,j,k,l,m,n=6378137,o=.081819190842622,p=3.141592653589793;f=Math.sqrt(Math.pow(n,2)*(1-Math.pow(o,2))),g=Math.sqrt((Math.pow(n,2)-Math.pow(f,2))/Math.pow(f,2)),h=Math.sqrt(Math.pow(a,2)+Math.pow(d,2)),i=Math.atan2(n*b,f*h),j=Math.atan2(d,a),k=Math.atan2(b+g*g*f*Math.pow(Math.sin(i),3),h-o*o*n*Math.pow(Math.cos(i),3)),l=n/Math.sqrt(1-o*o*Math.pow(Math.sin(k),2)),m=h/Math.cos(k)-l,k=180*k/p,j=180*j/p;var q=new c(k,j);return q},a}();a.XyzPosition=b;var c=function(){function a(a,b,c){this.latitude=a,this.longitude=b,this.earthRadius=null!=c&&void 0!=c?c:EarthJsHelper.Container.instance.dependencies.appInstance.dataPointDistance,this.calculateCartesianCoordinates()}return a.prototype.calculateCartesianCoordinates=function(){var a=this.latitude,b=this.longitude;this.latitude=this.latitude*Math.PI/180,this.longitude=this.longitude*Math.PI/180,this.x=this.getX(),this.y=this.getY(),this.z=this.getZ(),this.latitude=a,this.longitude=b},a.prototype.getX=function(){var a=this.earthRadius*Math.cos(this.longitude)*Math.cos(this.latitude);return a},a.prototype.getY=function(){var a=this.earthRadius*Math.sin(this.latitude);return a},a.prototype.getZ=function(){var a=-1*this.earthRadius*Math.cos(this.latitude)*Math.sin(this.longitude);return a},a}();a.LatLongPosition=c}(EarthJsModel||(EarthJsModel={}));var EarthJsModel;!function(a){var b=function(){function a(a,b,c,d,e,f,g){this.id=a,this.title=b,this.latitude=c,this.longitude=d,this.detail=e,this.annotationType=f,this.annotationImage=g}return a}();a.JsonDataPoint=b}(EarthJsModel||(EarthJsModel={}));var EarthJsView;!function(a){var b=function(){function a(a){this.dataPoint=a,this.currentSize=1,this.earthManager=EarthJsHelper.Container.instance.dependencies.earthInstance,this.app=EarthJsHelper.Container.instance.dependencies.appInstance}return a.prototype.getType=function(){return"dot"},a.prototype.applyToEarth=function(){if(null!==this.earthManager&&void 0!==this.earthManager&&null!==this.earthManager.earthMesh&&void 0!==this.earthManager.earthMesh){var a=new THREE.ImageUtils.loadTexture(this.dataPoint.annotationImage),b=new THREE.MeshBasicMaterial({map:a});b.transparent=!0,b.opacity=0,b.depthWrite=!1;var c=new THREE.MeshBasicMaterial;c.transparent=!0,c.opacity=0,c.depthWrite=!1;var d=this;null!=a.image&&void 0!=a.image&&(a.image.onload=function(){d.mesh=new THREE.Object3D,d.mesh.overdraw=!0;var a=10,e=10,f=new THREE.Mesh(new THREE.PlaneGeometry(a,e),b);if(d.mesh.add(f),null!=d.dataPoint.title&&void 0!=d.dataPoint.title&&""!=d.dataPoint.title){var g=THREE.FontUtils.generateShapes(d.dataPoint.title,{font:"helvetiker",weight:"bold",size:3}),h=new THREE.ShapeGeometry(g),i=new THREE.Mesh(h,c);d.mesh.add(i);var j=i.geometry.boundingSphere.radius/2;i.position.y=-e,i.position.x=-j}d.mesh.position.x=d.dataPoint.position.x,d.mesh.position.y=d.dataPoint.position.y,d.mesh.position.z=d.dataPoint.position.z,d.mesh.dataPoint=d.dataPoint,d.mesh.lookAt(d.earthManager.camera.position),d.earthManager.earthMesh.add(d.mesh),d.app.registerRenderHook("dotAnnotation",d,d.onRender)});var e=setInterval(function(){b.opacity<=.99?(b.opacity+=.01,c.opacity+=.01):(b.opacity=1,c.opacity=1,clearInterval(e))},10)}},a.prototype.removeFromEarth=function(){if(null!==this.earthManager&&void 0!==this.earthManager&&null!==this.earthManager.earthMesh&&void 0!==this.earthManager.earthMesh){var a=1,b=this,c=setInterval(function(){if(a>=.01)for(var d=0;d<b.mesh.children.length;d++)a-=.01,b.mesh.children[d].material.opacity=a;else clearInterval(c),b.earthManager.earthMesh.remove(this.mesh)},10);this.app.unregisterRenderHook("dotAnnotation",this)}},a.prototype.hoveredOver=function(){this.hasHoveredOver=!0,this.hasHoveredOut=!1},a.prototype.hoveredOut=function(){this.hasHoveredOver=!1,this.hasHoveredOut=!0},a.prototype.onRender=function(a){var b=EarthJsHelper.Container.instance.dependencies.earthInstance;a.mesh.lookAt(b.camera.position),a.mesh.children,a.hasHoveredOver?a.currentSize<1.5?(a.mesh.scale.set(a.currentSize,a.currentSize,1),a.currentSize+=.1):a.hasHoveredOver=!1:a.hasHoveredOut&&(a.currentSize>1?(a.mesh.scale.set(a.currentSize,a.currentSize,1),a.currentSize-=.1):a.hasHoveredOut=!1)},a}();a.DotAnnotation=b}(EarthJsView||(EarthJsView={}));var EarthJsView;!function(a){var b=function(){function a(a){this.dataPoint=a,this.earthManager=EarthJsHelper.Container.instance.dependencies.earthInstance}return a.prototype.getType=function(){return"earthTexture"},a.prototype.applyToEarth=function(){if(null!==this.earthManager&&void 0!==this.earthManager&&null!==this.earthManager.earthMesh&&void 0!==this.earthManager.earthMesh){var a=THREE.ImageUtils.loadTexture(this.dataPoint.annotationImage);this.earthManager.earthMesh.material.map=a}},a.prototype.removeFromEarth=function(){null===this.earthManager||void 0===this.earthManager||null===this.earthManager.earthMesh||void 0===this.earthManager.earthMesh},a.prototype.hoveredOver=function(){},a.prototype.hoveredOut=function(){},a}();a.EarthTextureAnnotation=b}(EarthJsView||(EarthJsView={}));var EarthJsModel;!function(a){var b=function(){function b(a,b,c,d,e,f){this.id=a,this.title=b,this.position=c,this.detail=d,this.annotationType=e,this.annotationImage=f,"dot"===this.annotationType?this.annotation=new EarthJsView.DotAnnotation(this):"earthTexture"===this.annotationType&&(this.annotation=new EarthJsView.EarthTextureAnnotation(this))}return b.createDataPointFromJsonDataPoint=function(b){var c=new a.DataPoint(b.id,null===b.title||void 0===b.title?"":b.title,new a.LatLongPosition(null===b.latitude||void 0===b.latitude?0:b.latitude,null===b.longitude||void 0===b.longitude?0:b.longitude),null===b.detail||void 0===b.detail?"":b.detail,null===b.annotationType||void 0===b.annotationType?"dot":b.annotationType,null===b.annotationImage||void 0===b.annotationImage?"":b.annotationImage);return c},b}();a.DataPoint=b}(EarthJsModel||(EarthJsModel={}));var EarthJsController;!function(a){var b=function(){function b(b){this.dataPointSelectedCallBack=b,a.DataPointController.instance=this,this.dataPoints=[]}return b.prototype.loadDataPoints=function(b){this.removeDataPoints();for(var c=[],d=0;d<b.length;d++){var e=b[d];c.push(EarthJsModel.DataPoint.createDataPointFromJsonDataPoint(e))}a.DataPointController.instance.dataPointsLoaded(c)},b.prototype.selectDataPointById=function(a){for(var b=0;b<this.dataPoints.length;b++)this.dataPoints[b].id===a&&this.dataPointSelected(this.dataPoints[b])},b.prototype.addDataPoint=function(a){var b=EarthJsModel.DataPoint.createDataPointFromJsonDataPoint(a);this.dataPoints.push(b),b.annotation.applyToEarth()},b.prototype.removeDataPoints=function(){if(null!==this.dataPoints&&void 0!==this.dataPoints){for(var b=0;b<this.dataPoints.length;b++)"earthTexture"!==this.dataPoints[b].annotation.getType()&&this.dataPoints[b].annotation.removeFromEarth();a.DataPointController.instance.dataPointsLoaded([])}},b.prototype.removeDataPointById=function(a){for(var b=-1,c=0;c<this.dataPoints.length;c++)if(this.dataPoints[c].id===a){this.dataPoints[c].annotation.removeFromEarth(),b=c;break}-1!=b&&this.dataPoints.splice(b,1)},b.prototype.dataPointSelected=function(a){var b=EarthJsHelper.Container.instance.dependencies.earthInstance;b.dataPointClicked(a),null!=this.dataPointSelectedCallBack&&void 0!=this.dataPointSelectedCallBack&&this.dataPointSelectedCallBack(a)},b.prototype.dataPointsLoaded=function(b){a.DataPointController.instance.dataPoints=b;for(var c=0;c<this.dataPoints.length;c++)this.dataPoints[c].annotation.applyToEarth()},b}();a.DataPointController=b}(EarthJsController||(EarthJsController={}));var EarthJsHelper;!function(a){var b=function(){function b(b){this.controls=b,this.cameraIncrementStep=.2,this.app=a.Container.instance.dependencies.appInstance}return b.prototype.getIncrementBasedOnCameraPosition=function(a,b){var c;return c=a*b>0?b>a?this.cameraIncrementStep:a>b?-this.cameraIncrementStep:0:b>a?this.cameraIncrementStep:-this.cameraIncrementStep},b.prototype.moveCameraToLatLongCoordinates=function(a){var b,c,d,e,f=a.latitude,g=a.longitude,h=new EarthJsModel.XyzPosition(this.controls.object.position.x,this.controls.object.position.y,this.controls.object.position.z,1e3),i=h.calculateLatitudeLongitude(),j=[];b=i.latitude,c=i.longitude,d=this.getIncrementBasedOnCameraPosition(b,f),e=this.getIncrementBasedOnCameraPosition(c,g);var k=Math.abs(Math.abs(b)-Math.abs(f)),l=Math.abs(Math.abs(c)-Math.abs(g));for(k>l?e/=Math.abs(k/l):d/=Math.abs(l/k);Math.abs(b-f)>this.cameraIncrementStep||Math.abs(c-g)>this.cameraIncrementStep;){var m=null===this.app.cameraDistance||void 0===this.app.cameraDistance?1e3:this.app.cameraDistance,n=new EarthJsModel.LatLongPosition(b,c,m);j.push(n),Math.abs(b-f)>this.cameraIncrementStep&&(b+=d),Math.abs(c-g)>this.cameraIncrementStep&&(c+=e)}var o=0,p=this;if(j.length>0)var q=setInterval(function(){p.controls.object.position.x=j[o].x,p.controls.object.position.y=j[o].y,p.controls.object.position.z=j[o].z,o+=1,o===j.length&&(window.clearInterval(q),j=null)},5)},b.prototype.moveCamera=function(a,b){var c=this.controls.object.position.x,d=this.controls.object.position.y,e=this.controls.object.position.z,f=this.controls.target.x,g=this.controls.target.y,h=this.controls.target.z,i={x:c,y:d,z:e},j={x:a.head.x,y:a.head.y,z:a.head.z},k={x:f,y:g,z:h},l={x:a.target.x,y:a.target.y,z:a.target.z},m=this;this.tween1=new TWEEN.Tween({x:i.x,y:i.y,z:i.z}).to(j,1e3*b).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){m.controls.object.position.x=this.x,m.controls.object.position.y=this.y,m.controls.object.position.z=this.z}).start(),this.tween2=new TWEEN.Tween({x:k.x,y:k.y,z:k.z}).to(l,1e3*b).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){m.controls.target.x=this.x,m.controls.target.y=this.y,m.controls.target.z=this.z}).start()},b}();a.CameraHelper=b}(EarthJsHelper||(EarthJsHelper={}));var EarthJsController;!function(a){var b=function(){function a(a,b,c){this.scene=a,this.camera=b,this.controls=c,this.cameraHelper=new EarthJsHelper.CameraHelper(c);var d=new THREE.SphereGeometry(100,20,20),e=new THREE.MeshBasicMaterial({color:16777215});this.earthMesh=new THREE.Mesh(d,e);var f=THREE.ImageUtils.loadTexture(""),g=new THREE.SpriteMaterial({map:f,useScreenCoordinates:!1,blending:THREE.AdditiveBlending});this.atmosphereMesh=new THREE.Sprite(g),this.atmosphereMesh.position.x=0,this.atmosphereMesh.position.y=0,this.atmosphereMesh.position.z=0,this.atmosphereMesh.scale=new THREE.Vector3(270,270,270),this.earthMesh.add(this.atmosphereMesh),a.add(this.earthMesh)}return a.prototype.clickDataPoint=function(a){if(null!=a&&void 0!=a){var b=EarthJsHelper.Container.instance.dependencies.dataInstance;b.dataPointSelected(a)}},a.prototype.dataPointClicked=function(a){this.cameraHelper.moveCameraToLatLongCoordinates(a.position)},a.prototype.setTexture=function(a){var b=THREE.ImageUtils.loadTexture(a);this.earthMesh.material.map=b},a.prototype.setAtmosphereTexture=function(a){var b=THREE.ImageUtils.loadTexture(a);this.atmosphereMesh.material.map=b},a}();a.EarthController=b}(EarthJsController||(EarthJsController={}));var EarthJsModel;!function(a){var b=function(){function a(a,b){this.name=a,this.method=b}return a}();a.RenderHook=b}(EarthJsModel||(EarthJsModel={}));var EarthJsApp;!function(a){function b(){for(var a=0;a<r.length;a++)null!=r[a].method&&null!=r[a].caller&&r[a].method(r[a].caller);d.render(e,f)}function c(a){requestAnimationFrame(function(){c(new Date)}),a-+l>33&&(TWEEN.update(),g.update(),b(),l=a)}var d,e,f,g,h,i,j,k,l=new Date,m=400,n=150,o=2.7,p=120,q=600,r=[],s={x:0,y:0},t={x:0,y:0},u={x:0,y:0},v=function(){function b(b){this.htmlContainer=b,h=b,this.container=new EarthJsHelper.Container,a.App.instance=this,this.container.register("appInstance",a.App.instance),j=this,this.cameraDistance=300,this.dataPointDistance=120}return b.prototype.registerRenderHook=function(a,b,c){for(var d=0;d<r.length;d++)if(r[d].name===a&&r[d].caller===b)return r[d].caller=b,r[d].method=c,void 0;r.push({name:a,caller:b,method:c})},b.prototype.unregisterRenderHook=function(a,b){for(var c=0;c<r.length;c++)if(r[c].name===a&&r[c].caller===b)return r[c].caller=null,r[c].method=null,void 0},b.prototype.start=function(){this.init(),c(new Date)},b.prototype.setDataPoints=function(a){var b=EarthJsHelper.Container.instance.dependencies.dataInstance;b.loadDataPoints(a)},b.prototype.removeDataPoints=function(){var a=EarthJsHelper.Container.instance.dependencies.dataInstance;a.removeDataPoints()},b.prototype.removeDataPointById=function(a){var b=EarthJsHelper.Container.instance.dependencies.dataInstance;b.removeDataPointById(a)},b.prototype.addDataPoint=function(a){var b=EarthJsHelper.Container.instance.dependencies.dataInstance;b.addDataPoint(a)},b.prototype.setDataPointClickedCallback=function(a){var b=EarthJsHelper.Container.instance.dependencies.dataInstance;b.dataPointSelectedCallBack=a},b.prototype.setEarthTexture=function(a){this.earthManager.setTexture(a)},b.prototype.setAtmosphereTexture=function(a){this.earthManager.setAtmosphereTexture(a)},b.prototype.setSize=function(a,b){m=a,n=b},b.prototype.init=function(){this.setupScene(),this.setupCamera(),this.setupEvents();var a=new EarthJsController.DataPointController(null);this.container.register("dataInstance",a),this.earthManager=new EarthJsController.EarthController(e,f,g),this.container.register("earthInstance",this.earthManager);var b=new EarthJsModel.JsonDataPoint("0","EarthTexture",0,0,"","earthTexture","/examples/images/EarthTexture.jpg");a.loadDataPoints([b])},b.prototype.setupScene=function(){e=new THREE.Scene,i=new THREE.Projector,d=Detector.webgl?new THREE.WebGLRenderer:new THREE.CanvasRenderer,d.setSize(m,n),h.appendChild(d.domElement)},b.prototype.setupCamera=function(){f=new THREE.PerspectiveCamera(55,o,p,q),f.position.x=this.cameraDistance,g=new THREE.TrackballControls(f,h),g.rotateSpeed=1,g.zoomSpeed=.05,g.panSpeed=.2,g.noZoom=!1,g.noPan=!1,g.staticMoving=!1,g.dynamicDampingFactor=.3,g.minDistance=250,g.maxDistance=350,g.keys=[65,83,68]},b.prototype.setupEvents=function(){window.addEventListener("resize",this.onWindowResize,!1),h.addEventListener("mouseup",this.onDocumentMouseUp,!1),h.addEventListener("mousedown",this.onDocumentMouseDown,!1),h.addEventListener("mousemove",this.onDocumentMouseMove,!1),this.onWindowResize(null)},b.prototype.detectEvent=function(){var a=new THREE.Vector3(s.x,s.y,.5);i.unprojectVector(a,f);var b=new THREE.Raycaster(f.position,a.sub(f.position).normalize()),c=b.intersectObjects(j.earthManager.earthMesh.children,!0);if(c.length>0){var d=c[0].object.parent;k!=d.dataPoint&&(k=d.dataPoint,null!=k&&void 0!=k&&k.annotation.hoveredOver())}else this.hoveredOut();u.x=s.x,u.y=s.y},b.prototype.hoveredOut=function(){null!=k&&k.annotation.hoveredOut(),k=null},b.prototype.onDocumentMouseMove=function(b){var c=a.App.instance.findElementPosition(h);if(!(b.clientX>c.x+m||b.clientY>c.y+n)){var d={x:b.clientX-c.x,y:b.clientY-c.y};s.x=2*(d.x/m)-1,s.y=2*-(d.y/n)+1,(Math.abs(u.x-s.x)>.01||Math.abs(u.y-s.y)>.01)&&a.App.instance.detectEvent()}},b.prototype.findElementPosition=function(a){var b,c;if(b=0,c=0,a.offsetParent)do b+=a.offsetLeft,c+=a.offsetTop;while(a=a.offsetParent);return{x:b,y:c}},b.prototype.onDocumentMouseUp=function(a){a.preventDefault(),s.x=2*(a.clientX/window.innerWidth)-1,s.y=2*-(a.clientY/window.innerHeight)+1;var b={x:0,y:0};b.x=Math.abs(s.x-t.x),b.y=Math.abs(s.y-t.y),b.x<.001&&b.y<.001&&null!=k&&void 0!=k&&j.earthManager.clickDataPoint(k)},b.prototype.onDocumentMouseDown=function(a){t.x=2*(a.clientX/window.innerWidth)-1,t.y=2*-(a.clientY/window.innerHeight)+1},b.prototype.onWindowResize=function(){var a=0===m?window.innerWidth:m,b=0===n?window.innerHeight:n;f.aspect=a/b,f.updateProjectionMatrix(),d.setSize(a,b),d.domElement.style.width=a+"px",d.domElement.style.height=b+"px"},b}();a.App=v}(EarthJsApp||(EarthJsApp={}));